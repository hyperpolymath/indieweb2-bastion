FROM cgr.dev/chainguard/wolfi-base:latest AS builder
RUN apk add --no-cache build-base deno git npm
WORKDIR /app
COPY . .
# Install local rescript
RUN npm install rescript
# Compile ReScript
RUN ./node_modules/.bin/rescript build -with-deps
# Run generator
RUN deno run --allow-read --allow-write --allow-env src/scripts/GenerateShells.bs.js

# Runtime
FROM cgr.dev/chainguard/wolfi-base:latest
# RSR: Add libcap to allow non-root bind to port 443
RUN apk add --no-cache deno ca-certificates libcap

WORKDIR /app
COPY --from=builder /app/src/scripts/*.bs.js ./dist/

# Grant Deno permission to bind privileged ports (<1024)
RUN setcap 'cap_net_bind_service=+ep' $(readlink -f $(which deno))

USER nonroot
EXPOSE 443

CMD ["deno", "run", "--allow-net", "--allow-read", "dist/Bastion.bs.js"]
