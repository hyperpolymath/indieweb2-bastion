FROM cgr.dev/chainguard/wolfi-base:latest AS builder
RUN apk add --no-cache build-base deno git npm
WORKDIR /app
COPY . .
RUN npm install rescript
RUN ./node_modules/.bin/rescript build -with-deps
RUN deno run --allow-read --allow-write --allow-env src/scripts/GenerateShells.bs.js

# Runtime
FROM cgr.dev/chainguard/wolfi-base:latest
# RSR: libcap required for privileged port binding
RUN apk add --no-cache deno ca-certificates libcap

WORKDIR /app
COPY --from=builder /app/src/scripts/*.bs.js ./dist/

# Create cert directory
RUN mkdir -p /app/certs && chown nonroot:nonroot /app/certs

# Grant bind permission for Port 443
RUN setcap 'cap_net_bind_service=+ep' $(readlink -f $(which deno))

USER nonroot

EXPOSE 443/tcp
EXPOSE 443/udp

CMD ["deno", "run", "--allow-net", "--allow-read", "dist/Bastion.bs.js"]
